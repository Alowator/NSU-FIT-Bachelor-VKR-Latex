\subsection{Обновление индекса}

Существуют две операции обновления индекса, которые требуют модификации индекса для отражения актуального состоянии, чтобы не допустить ложноотрицательных ответов. При добавлении, обновлении или удалении записей возможны два следующих случая сценария: 
\begin{enumerate}
    \item Добавление ключа $k$ в расположение $r$.
    \item Удаление ключа $k$ из расположения $r$.
\end{enumerate}

В дальнейшем будем называть упорядоченную пару $(k, r)$ \textbf{индексной записью}.

Сито-индекс на хранит в себе индексные записи, так как использует совершенно другую структуру, описывающую промежуток ключей, этой структурой является \textbf{блок} \fbox{ссылка?}. Однако определением {<<индексная запись>>} удобно оперировать в рамках операций обновления индекса.



С этой точки зрения, индекс должен быть синхронизирован с текущим состоянием таблицы. Для достижения этой синхронизации необходимо применять те же механизмы управления параллельными версиями (MVCC), которые используются для управления таблицей.

После накопления множества изменений (дельт) в индексе, необходимо провести процесс компактизации индекса в синхронизации с компактизацией индексируемой таблицы. Для поддержки фильтрации нерелевантных данных при выполнении исторических запросов требуется версионирование не только данных, но и индекса. При компактизации таблицы старая версия сегмента должна быть помечена тем же временным штампом, что и старая версия данных, после чего обновленный сегмент записывается в файловую систему.

2.3.1. Добавление записи
Процесс добавления записи, ключевой атрибут которой отсутствует в индексе, включает добавление в соответствующую группу файлов, ассоциированную с сегментом дельта-файла. Дельта-файл содержит информацию о добавленных ключах и о расположении соответствующих файлов данных на файловой системе.

2.3.2. Удаление записи
Большинство теоретических описаний подходов, используемых при создании Сито-индекса, не включает описание операции удаления ключа из индекса, хотя поддержка данной операции необходима. Подход к реализации этой операции аналогичен процессу добавления записи: необходимо записать в дельту, что ключ k был удален из индекса. В процессе компактизации следует удалить из индекса запись с указанием местоположения. Однако этот подход может быть некорректен при удалении ключа из блока, если местоположение, ассоциированное с удаленным ключом, соответствует также другим ключам, которые не были удалены. Это может привести к ложноотрицательным результатам, когда записи, соответствующие данному местоположению, окажутся утраченными.

Процесс удаления записи, ключевой атрибут которой присутствует в индексе, реализуется аналогично процессу добавления записи. Необходимо определить файловую группу, ассоциированную с сегментом, внести изменения и записать в дельта-файл информацию о удаленных ключах и их расположениях. Для предотвращения ложноотрицательных результатов в списке местоположений каждого блока следует хранить не только расположение файлов данных, но и количество ключей, которым соответствует данное расположение. Таким образом, удаление местоположения из подсегмента заключается в уменьшении второго элемента данной пары на одну единицу, если значение больше единицы, и в удалении пары из списка, если это значение равно единице. Аналогичные изменения необходимы также в процедуре добавления записей. Этот подход, называемый подсчетом (англ. counting), является общепринятым [16].

2.3.3. Обновление записи
Обновление записи в системе Hudi представляет собой более сложную концепцию по сравнению с традиционными системами управления базами данных (СУБД). В отличие от стандартных СУБД, Hudi поддерживает выполнение исторических запросов. В общем случае, при обновлении набора записей сохраняется предыдущий актуальный файл данных, а также создается новый файл данных, который отражает актуальное состояние данных после обновления. Таким образом, местоположение данных не изменяется с появлением нового файла данных, который соответствует последующему моменту времени на временной шкале. Для операций обновления записи по уже существующему ключу обновление индекса не требуется.
